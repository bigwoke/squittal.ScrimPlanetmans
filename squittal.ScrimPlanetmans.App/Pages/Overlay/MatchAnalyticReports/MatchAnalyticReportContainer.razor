@using squittal.ScrimPlanetmans.App.Pages.Shared;
@using squittal.ScrimPlanetmans.Models;
@using squittal.ScrimPlanetmans.Models.ScrimMatchReports;
@using squittal.ScrimPlanetmans.ScrimMatch;
@using squittal.ScrimPlanetmans.ScrimMatch.Messages;
@using squittal.ScrimPlanetmans.ScrimMatch.Models;
@using squittal.ScrimPlanetmans.Services.ScrimMatch;
@using squittal.ScrimPlanetmans.Services.ScrimMatchReports;
@using System.Threading;
@using System.Text.RegularExpressions;

@inject IScrimTeamsManager ScrimTeamsManager 
@inject IScrimMatchEngine ScrimMatchEngine
@inject IScrimMessageBroadcastService MessageService
@inject IScrimMatchReportDataService ReportDataService
@inject NavigationManager NavManager

@implements IDisposable

@if (!string.IsNullOrWhiteSpace(_scrimMatchId) && _currentRound > 0)
{
    <div class="analytic-report-container container-fluid">
        <div class="analytic-report-container-row row">
            <div class="analytic-report-container-col col-lg-12">
                <div class="header-card-container default" style="color: rgb(245, 245, 255); background-color: var(--sq-ov-bg-dark-gray-alpha-90); box-shadow: 0px 2px 5px 0px var(--sq-ov-bg-dark-gray-alpha-90); overflow-x: auto; border: 2px solid var(--sq-ov-bg-dark-gray); border-radius: 0;">
                    @if (Debug)
                    {
                        <p style="margin: 0;">_scrimMatchId: @_scrimMatchId</p>
                        <p style="margin: 0;">_renderedScrimMatchId: @_renderedScrimMatchId</p>
                        <p style="margin: 0;">_isLoadingScrimPlayers: @_isLoadingScrimPlayers</p>
                        <p style="margin: 0;">_isChangingScrimMatch: @_isChangingScrimMatch</p>
                        <p style="margin: 0;">_refreshTimerCount: @_refreshTimerCount</p>
                        <p style="margin: 0;">_matchStateUpdateCount: @_matchStateUpdateCount</p>
                        <p style="margin: 0;">_currentRound: @_currentRound</p>
                        <p style="margin: 0;">_renderedCurrentRoundOnly: @_renderedCurrentRoundOnly</p>

                        <p style="margin: 0; margin-top: 8px;">_playerStats is null?: @(_playerStats == null)</p>
                        <p style="margin: 0;">_teamStats is null?: @(_teamStats == null)</p>
                        <p style="margin: 0;">_teamRoundStats is null?: @(_teamRoundStats == null)</p>
                        @if (_teamRoundStats != null)
                        {
                        <p style="margin: 0;">_teamRoundStats count: @(_teamRoundStats.Count())</p>
                        }
                        <p style="margin: 0;">_playerRoundStats is null?: @(_playerRoundStats == null)</p>
                        @if (_playerRoundStats != null)
                        {
                        <p style="margin: 0;">_playerRoundStats count: @(_playerRoundStats.Count())</p>
                        }
                        <p style="margin: 0;">_playerRoundStats is null?: @(_playerRoundStats == null)</p>
                        @if (_playerRoundStats != null)
                        {
                        <p style="margin: 0;">_playerRoundStats count: @(_playerRoundStats.Count())</p>
                        }
                        <p style="margin: 0;">_matchInfo is null?: @(_matchInfo == null)</p>
                    }

                    @if (_matchInfo == null  && _isChangingScrimMatch)
                    {
                        <SpinnerEllipsis />
                    }
                    else
                    {
                        <div style="display: grid; grid-template-columns: 60% 40%; align-items: baseline; font-family: Roboto, 'Segoe UI', sans-serif; margin-bottom: 12px;">
                            <!--<h4 style="margin-bottom: 0; font-family: 'Roboto Mono', 'Input Mono', Consolas, monospace">@(_matchInfo.Title)</h4>--> @*margin-bottom: 2px;
                            @*<p style="margin-bottom: 0px; font-size: 1rem; text-align: right;">@_matchInfo.StartTime.ToString("f")</p>*@
                            @if (string.IsNullOrWhiteSpace(_matchInfo.FacilityName))
                            {
                                <p style="margin-bottom: 0px; font-size: 1rem;">
                                    @*<span>@_matchInfo.WorldName</span>*@
                                    @*<span class="oi oi-caret-right small" style="padding-left: 4px; padding-right: 4px;"></span>*@
                                    @*<span style="font-style: italic;">No facility</span>*@
                                    @if (_renderedCurrentRoundOnly)
                                    {
                                        <span>Round @_currentRound Report</span>
                                    }
                                    else
                                    {
                                        <span>Match Report</span>
                                    }
                                </p>
                            }
                            else
                            {
                                <p style="margin-bottom: 0px; font-size: 1rem;">
                                    @*<span>@_matchInfo.WorldName</span>*@
                                    <span>@_matchInfo.FacilityName</span>
                                    <span class="oi oi-caret-right small" style="padding-left: 4px; padding-right: 4px;"></span>
                                    @if (_renderedCurrentRoundOnly)
                                    {
                                        <span>Round @_currentRound Report</span>
                                    }
                                    else
                                    {
                                        <span>Match Report</span>
                                    }
                                </p>
                            }
                            @*<p style="margin-bottom: 0px; font-size: 1rem; text-align: right; font-weight: 300;">@_matchInfo.RoundCount Rounds | Ruleset: @_matchInfo.RulesetName</p>*@

                        </div>

                        @*@if (_isLoadingScrimPlayers || _matchInfo == null)*@

                        @if (_matchInfo == null)
                        {
                            @*<p>Spin 2</p>
                            <SpinnerEllipsis />*@
                        }
                        else if (!_matchInfo.TeamAliases.Any() || (!_renderedCurrentRoundOnly && (_playerStats == null || !_playerStats.Any() || _teamStats == null || !_teamStats.Any())) || (_renderedCurrentRoundOnly && (_playerRoundStats == null || _teamRoundStats == null || !_teamRoundStats.Any())))
                        {
                            <p class="sans-serif-font" style="color: rgb(245, 245, 255); margin-top: 0.5rem; margin-bottom: 0.5rem;">No player data found for match @_scrimMatchId</p>
                        }
                        else
                        {

                            @*@if (_teamRoundStats != null && _teamRoundStats.Any() && _playerRoundStats != null && _playerRoundStats.Any())
                            {
                                <div style="text-align: right; margin-top: 4px; margin-bottom: 2px; padding-bottom: 4px;">

                                    @if (!_showAllRoundStats)
                                    {
                                        <button class="btn btn-link" style="padding: 0; font-size: 0.9rem; font-family: Roboto, 'Segoe UI', sans-serif" @onclick="OnShowAllRoundStats">Expand All Rounds</button>

                                        @if (_expandedRoundPlayers.Any() || _expandedRoundTeams.Any() || _expandedRoundTeamCaptures.Any())
                                        {
                                            <span style="padding: 0 8px 0 8px; font-size: 0.9rem; font-family: Roboto, 'Segoe UI', sans-serif;">|</span>
                                        }
                                    }

                                    @if (_showAllRoundStats || _expandedRoundPlayers.Any() || _expandedRoundTeams.Any() || _expandedRoundTeamCaptures.Any())
                                    {
                                        <button class="btn btn-link" style="padding: 0; font-size: 0.9rem; font-family: Roboto, 'Segoe UI', sans-serif;" @onclick="OnHideAllRoundStats">Collapse All Rounds</button>
                                    }

                                </div>
                            }*@

                            <table style="width: 100%; text-align: right; margin-bottom: 10px;" class="table-responsive-sm table-striped-dark analytic-match-report">

                                <tbody style="font-size: 0.85rem;">
                                    @if (!_renderedCurrentRoundOnly && _teamStats != null)
                                    {
                                        @foreach (var team in _teamStats)
                                        {
                                            @if (team.TeamOrdinal > 1)
                                            {
                                                <tr style="height: 16px;">
                                                </tr>
                                            }

                                            <tr style="line-height: 1.2; font-size: 0.8rem; vertical-align: bottom; background-color: transparent; font-family: Roboto, 'Segoe UI', sans-serif; color: rgb(245, 245, 255);">
                                                <th style="padding-left: 8px; width: 10px;" title="Primary Class"></th>
                                                <th style="width: 145px"></th>

                                                @if (!_useObjectiveStats)
                                                {
                                                    <th style="text-align: right; font-weight: 300; width: 60px;" title="Total Points">Points</th>
                                                    <th style=" width: 90px;"></th>
                                                    <th style="font-weight: 300; width: 70px;" title="Net Score">Net Score</th>
                                                }

                                                @*<th style="font-weight: 300; width: 60px;" title="Kills">Kills</th>
                                                <th style="font-weight: 300; width: 60px;" title="Deaths">Deaths</th>*@

                                                @if (_anyRevives)
                                                {
                                                    <th colspan="2" style="font-weight: 300; width: 120px;" title="Kills">
                                                        @*<div style="width: 100%; display: grid; grid-template-rows: 50% 50%; grid-template-columns: 33% 33% 34%;">*@
                                                        <div style="width: 100%; display: grid; grid-template-rows: 50% 50%; grid-template-columns: 50% 50%;">
                                                            <div class="multi-col-header" style="grid-column: 1 / -1; text-align: center; grid-row: 1; font-weight: 400;">Kills</div>
                                                            <div style="grid-row: 2; grid-column: 1; text-align: right;">Secured</div>
                                                            <div style="grid-row: 2; grid-column: 2; text-align: right;">Total</div>
                                                            @*<div style="grid-row: 2; grid-column: 3; text-align: right;">Post-Rev.</div>*@
                                                        </div>
                                                    </th>

                                                    <th colspan="2" style="font-weight: 300; width: 120px;" title="Deaths">
                                                        <div style="width: 100%; display: grid; grid-template-rows: 50% 50%; grid-template-columns: 50% 50%;">
                                                            <div class="multi-col-header" style="grid-column: 1 / -1; text-align: center; grid-row: 1; font-weight: 400;">Deaths</div>
                                                            <div style="grid-row: 2; grid-column: 1; text-align: right;">Final</div>
                                                            <div style="grid-row: 2; grid-column: 2; text-align: right;">Total</div>
                                                        </div>
                                                    </th>

                                                    <th style="font-weight: 300; width: 60px;" title="Revives Given">Revives<br />Given</th>
                                                    <th colspan="3" style="font-weight: 300; width: 180px;" title="Revives Taken">
                                                        @*<div style="width: 100%; display: grid; grid-template-rows: 50% 50%; grid-template-columns: 50% 50%;">*@
                                                        <div style="width: 100%; display: grid; grid-template-rows: 50% 50%; grid-template-columns: 33% 34% 33%;">
                                                            <div class="multi-col-header" style="grid-column: 1 / -1; text-align: center; grid-row: 1; margin-left: 4px; font-weight: 400;">Revives Taken</div>
                                                            <div style="grid-row: 2; grid-column: 1; text-align: right;" title="Average Life in Seconds">Avg. Life</div>
                                                            <div style="grid-row: 2; grid-column: 2; text-align: right;" title="Deaths within 2 seconds of being revived">Inst. Dth.</div>
                                                            <div style="grid-row: 2; grid-column: 3; text-align: right;" title="Kills while on a revived life">Kills</div>
                                                            @*<div style="grid-row: 2; grid-column: 2; text-align: right;">Taken</div>*@
                                                        </div>
                                                    </th>

                                                    @*<th style="font-weight: 300; width: 60px;" title="Kills">Revives<br />Given</th>
                                                    <th style="font-weight: 300; width: 60px;" title="Deaths">Revives<br />Taken</th>*@
                                                }
                                                else
                                                {
                                                    <th style="font-weight: 300; width: 60px;" title="Kills">Kills</th>
                                                    <th style="font-weight: 300; width: 60px;" title="Deaths">Deaths</th>
                                                }

                                                @if (ShowHsr)
                                                {
                                                    <th style="font-weight: 300; width: 55px;" title="Head Shot Percent">
                                                        <div class="ps2-icon headshot tr" style="filter: brightness(100) saturate(100%); display: inline-block; margin-top: 0px;"></div>%
                                                    </th>
                                                }

                                                <th style="font-weight: 300; width: 55px;" title="Damage Assists">Dmg.<br />Asst.</th>
                                                <th style="font-weight: 300; width: 70px;" title="Damage Dealt">Dmg.<br />Dealt</th>

                                                <th style="font-weight: 300; width: 60px;" title="Solo/Unassisted Kills (including spot-assisted-only kills)">Solo<br />Kills</th>
                                                <th style="font-weight: 300; width: 60px;" title="Assisted Deaths (excluding spot-assisted-only deaths)">Asst.<br />Deaths</th>
                                                <th style="font-weight: 300; width: 60px;" title="Trickle Deaths">Trickle<br />Deaths</th>
                                                <th style="font-weight: 300; width: 65px;" title="Favorable Engagement Percent">Favorable<br />Eng. %</th>
                                                <th style="font-weight: 300; width: 65px;" title="One vs One Engagement Percent">1v1<br />Eng. %</th>
                                                <th style="font-weight: 300; width: 60px; padding-right: 8px;" title="One vs One Kill Death Ratio">1v1<br />KDR</th>
                                            </tr>

                                            <tr class="@SqCssHelper.GetFactionClassFromId(ScrimTeamsManager.GetTeam(team.TeamOrdinal).FactionId)" style="color: var(--sq-ov-ps2-primary-light); font-size: 0.9rem; background-color: transparent; border-bottom: 2px solid var(--sq-ov-ps2-primary); text-align: right; border-top: none !important; vertical-align: baseline; line-height: 1.2rem;">
                                                <td style="padding-left: 8px; padding-top: 0px;"></td>
                                                <td style="text-align: left; font-size: 1.2rem;">@(_matchInfo.TeamAliases[team.TeamOrdinal])</td>

                                                @if (!_useObjectiveStats)
                                                {
                                                    <td style="padding-top: 0px;">@team.Points</td>
                                                    <td style="padding-top: 0px;"></td>
                                                    <td style="padding-top: 0px;">@team.NetScore</td>
                                                }

                                                @*<td style="padding-top: 0px;">@team.Kills</td>
                                                <td style="padding-top: 0px;">@team.Deaths</td>*@

                                                @if (_anyRevives)
                                                {
                                                    <td style="padding-top: 0px; width: 60px;">@team.SecuredKills</td>
                                                    <td style="padding-top: 0px; width: 60px;">@team.Kills</td>
                                                    <td style="padding-top: 0px; width: 60px;">@team.ConfirmedDeaths</td>
                                                    <td style="padding-top: 0px; width: 60px;">@team.Deaths</td>
                                                    <td style="padding-top: 0px; width: 60px;">@team.Revives</td>
                                                    <td style="padding-top: 0px; width: 60px;">@team.AvgRevivedLifeSeconds<span style="font-size: smaller;">s</span></td>
                                                    <td style="padding-top: 0px; width: 60px;">@team.ReviveInstantDeaths</td>
                                                    @*<td style="padding-top: 0px; width: 60px;"></td>*@
                                                    <td style="padding-top: 0px; width: 60px;">@team.PostReviveKills</td>
                                                }
                                                else
                                                {
                                                    <td style="padding-top: 0px;">@team.Kills</td>
                                                    <td style="padding-top: 0px;">@team.Deaths</td>
                                                }


                                                @if (ShowHsr)
                                                {
                                                    <td style="padding-top: 0px;" title="@team.HeadshotKills / @team.Kills">@team.HeadshotPercent<span style="font-size: smaller;">%</span></td>
                                                }

                                                <td style="padding-top: 0px;">@team.DamageAssists</td>
                                                <td style="padding-top: 0px;" title="@($"{team.TotalDamageDealt.ToString("N0")}\nKills: {team.KillDamageDealt.ToString("N0")}\nAssists: {team.AssistDamageDealt.ToString("N0")}")">@GetAbbreviatedDamageDealt(team.TotalDamageDealt, true)</td>
                                                <td style="padding-top: 0px;">@team.UnassistedKills</td>
                                                <td style="padding-top: 0px;">@team.DamageAssistedEnemyDeaths</td>
                                                <td style="padding-top: 0px;">@team.TrickleDeaths</td>
                                                <td style="padding-top: 0px;" title="@team.FavorableEngagementCount / @team.WeightedEnemyEngagementCount">@team.WeightedFavorableEngagementPercent3<span style="font-size: smaller;">%</span></td>
                                                <td style="padding-top: 0px;" title="@team.OneVsOneCount / @team.EnemyKillDeathEngagementCount">@team.OneVsOneEngagementPercent<span style="font-size: smaller;">%</span></td>
                                                <td style="padding-top: 0px; padding-right: 8px;" title="@team.UnassistedKills / @team.UnassistedEnemyDeaths ">@team.OneVsOneKillDeathRatio</td>
                                            </tr>

                                            @foreach (var player in _playerStats.Where(p => p.TeamOrdinal == team.TeamOrdinal))
                                            {
                                                <tr class="@SqCssHelper.GetFactionClassFromId(player.FactionId)" style="color: rgb(245, 245, 255); font-weight: 400;">
                                                    <td style="padding-left: 8px;">
                                                        <div class="playerLoadoutIcon ps2-icon @GetLoadoutIconFromLoadoutId(player.GetOrderedPlanetsideClassEventCountsList().Select(e => e.PlanetsideClass).FirstOrDefault())" style="filter: @GetLoadoutIconFilterStyle(player.FactionId)"></div>@*@player.GetOrderedPlanetsideClassEventCountsList().OrderByDescending(e => e.EventCount).FirstOrDefault().EventCount</div>*@
                                                    </td>
                                                    <td style="text-align: left;" title="@player.NameFull [@(player.CharacterId)]">

                                                        <div class="nav-link" style="color: rgb(245, 245, 255); ">
                                                            <span style="text-overflow: ellipsis; overflow: hidden; max-width: 120px; display: inline-block; vertical-align: bottom;">@player.NameDisplay</span>
                                                            @*<span style="text-overflow: ellipsis; overflow: hidden; max-width: @(player.PrestigeLevel != 0 ? "108px" : "120px"); display: inline-block; vertical-align: bottom;">@player.NameDisplay</span>
                                                            @if (player.PrestigeLevel != 0)
                                                            {
                                                                <div style="display: inline-block; margin-left: -4px;" title="ASP Active">
                                                                    <sup>
                                                                        <span class="oi oi-star small" aria-hidden="true"></span>
                                                                    </sup>
                                                                </div>
                                                            }*@
                                                        </div>

                                                    </td>

                                                    @if (!_useObjectiveStats)
                                                    {
                                                        <td style="text-align: right; opacity: @(GetStatOpacity(player.Points));">@player.Points</td>
                                                        <td>
                                                            <div class="graph" style="width: 90px;">
                                                                <div class="graph-bar" style="width: @($"{GetPointGraphWidth(player.Points)}%"); height: 17px; margin: 0; background-color: var(--sq-ov-ps2-primary); opacity: 0.9; box-sizing: border-box; border: 1px solid var(--sq-ov-ps2-primary-dark-alpha-80); border-left: 2px solid var(--sq-ov-ps2-primary-dark);"></div>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <div class="net stats-value" style="margin-top: -0.1rem !important;">
                                                                <span class="value">@player.NetScore</span><span class="net-score-icon @GetNetScoreLabelCssClass(player.NetScore)">@GetNetScoreLabelText(player.NetScore)</span>
                                                            </div>
                                                        </td>
                                                    }

                                                    @*<td style="opacity: @(GetStatOpacity(player.Kills));">@player.Kills</td>
                                                    <td style="opacity: @(GetStatOpacity(player.Deaths));">@player.Deaths</td>

                                                    @if (_anyRevives)
                                                    {
                                                        <td style="padding-top: 0px;">@player.RevivesGiven</td>
                                                        <td style="padding-top: 0px;">@player.RevivesTaken</td>
                                                    }*@

                                                    @if (_anyRevives)
                                                    {
                                                        <td style="padding-top: 0px; opacity: @(GetStatOpacity(player.SecuredKills));">@player.SecuredKills</td>
                                                        <td style="padding-top: 0px; opacity: @(GetStatOpacity(player.Kills));">@player.Kills</td>
                                                        <td style="padding-top: 0px; opacity: @(GetStatOpacity(player.ConfirmedDeaths));">@player.ConfirmedDeaths</td>
                                                        <td style="padding-top: 0px; opacity: @(GetStatOpacity(player.Deaths));">@player.Deaths</td>
                                                        <td style="padding-top: 0px; opacity: @(GetStatOpacity(player.RevivesGiven));">@player.RevivesGiven</td>
                                                        @*<td style="padding-top: 0px; opacity: @(GetStatOpacity(player.ConfirmedDeaths));">@player.AvgRevivedLifeSeconds<span style="font-size: smaller;">s</span></td>*@
                                                        <td style="padding-top: 0px; opacity: @(GetStatOpacity(player.RevivesTaken));">@player.AvgRevivedLifeSeconds<span style="font-size: smaller;">s</span></td>
                                                        <td style="padding-top: 0px; opacity: @(GetStatOpacity(player.RevivesTaken));">@player.ReviveInstantDeaths</td>
                                                        <td style="padding-top: 0px; opacity: @(GetStatOpacity(player.RevivesTaken));">@player.PostReviveKills</td>
                                                        @*<td style="padding-top: 0px; opacity: @(GetStatOpacity(player.RevivesTaken));">@player.RevivesTaken</td>*@
                                                    }
                                                    else
                                                    {
                                                        <td style="padding-top: 0px; opacity: @(GetStatOpacity(player.Kills));">@player.Kills</td>
                                                        <td style="padding-top: 0px; opacity: @(GetStatOpacity(player.Deaths));">@player.Deaths</td>
                                                    }

                                                    @if (ShowHsr)
                                                    {
                                                        <td style="opacity: @(GetStatOpacity(player.Kills));" title="@player.HeadshotKills / @player.Kills">@player.HeadshotPercent<span style="font-size: smaller; padding-left: 1px;">%</span></td>
                                                    }

                                                    <td style="opacity: @(GetStatOpacity(player.DamageAssists));">@player.DamageAssists</td>
                                                    <td style="opacity: @(GetStatOpacity(player.TotalDamageDealt));" title="@($"{player.TotalDamageDealt.ToString("N0")}\nKills: {player.KillDamageDealt.ToString("N0")}\nAssists: {player.AssistDamageDealt.ToString("N0")}")">@player.TotalDamageDealt.ToString("N0")</td>
                                                    <td style="opacity: @(GetStatOpacity(player.UnassistedKills));">@player.UnassistedKills</td>
                                                    <td style="opacity: @(GetStatOpacity(player.DamageAssistedEnemyDeaths));">@player.DamageAssistedEnemyDeaths</td>
                                                    <td style="opacity: @(GetStatOpacity(player.TrickleDeaths));">@player.TrickleDeaths</td>
                                                    <td style="opacity: @(GetStatOpacity((int)player.WeightedEnemyEngagementCount));" title="@player.FavorableEngagementCount / @player.WeightedEnemyEngagementCount">@player.WeightedFavorableEngagementPercent3<span style="font-size: smaller; padding-left: 1px;">%</span></td>
                                                    <td style="opacity: @(GetStatOpacity(player.EnemyKillDeathEngagementCount));" title="@player.OneVsOneCount / @player.EnemyKillDeathEngagementCount">@player.OneVsOneEngagementPercent<span style="font-size: smaller; padding-left: 1px;">%</span></td>
                                                    <td style="padding-right: 8px; opacity: @(GetStatOpacity(player.UnassistedKills + player.UnassistedEnemyDeaths));" title="@player.UnassistedKills / @player.UnassistedEnemyDeaths">@player.OneVsOneKillDeathRatio</td>
                                                </tr>
                                            }

                                            @if (team.FacilityCapturePoints != 0)
                                            {
                                                <tr class="@SqCssHelper.GetFactionClassFromId(_playerStats.Where(p => p.TeamOrdinal == team.TeamOrdinal).Select(p => p.FactionId).FirstOrDefault())" style="background-color: transparent;">
                                                    <td style="padding-left: 10px;"></td>
                                                    <td colspan="1" style="text-align: left;">Captures</td>
                                                    <td>@team.FacilityCapturePoints</td>
                                                    <td colspan="12"></td>
                                                </tr>
                                            }

                                            @if (team.PeriodicControlTickPoints != 0)
                                            {
                                                <tr class="@SqCssHelper.GetFactionClassFromId(_playerStats.Where(p => p.TeamOrdinal == team.TeamOrdinal).Select(p => p.FactionId).FirstOrDefault())" style="background-color: transparent;">
                                                    <td style="padding-left: 10px;"></td>
                                                    <td colspan="1" style="text-align: left;">Control Ticks</td>
                                                    <td colspan="1" >@(team.PeriodicControlTickPoints)</td>
                                                    <td colspan="2" style="text-align: left; padding-left: 0.25rem; font-weight: 500;">(@(team.PeriodicControlTicks) ticks)</td>
                                                    <td colspan="9"></td>
                                                </tr>
                                            }

                                            @if (team.PointAdjustments != 0)
                                            {
                                                <tr class="@SqCssHelper.GetFactionClassFromId(_playerStats.Where(p => p.TeamOrdinal == team.TeamOrdinal).Select(p => p.FactionId).FirstOrDefault())" style="background-color: transparent;">
                                                    <td colspan="2" style="text-align: left;">Adjustments</td>
                                                    <td>@team.PointAdjustments</td>
                                                    <td colspan="12"></td>
                                                </tr>
                                            }

                                            <tr class="@SqCssHelper.GetFactionClassFromId(_playerStats.Where(p => p.TeamOrdinal == team.TeamOrdinal).Select(p => p.FactionId).FirstOrDefault())" style="background-color: transparent; border-bottom: 1px solid var(--sq-ov-ps2-primary);"></tr>
                                        }
                                    }
                                    else if (_renderedCurrentRoundOnly && _teamRoundStats != null)
                                    {
                                        @foreach (var team in _teamRoundStats.Where(t => t.ScrimMatchRound == _currentRound))
                                        {
                                            @if (team.TeamOrdinal > 1)
                                            {
                                                <tr style="height: 16px;">
                                                </tr>
                                            }

                                            <tr style="line-height: 1.2; font-size: 0.8rem; vertical-align: bottom; background-color: transparent; font-family: Roboto, 'Segoe UI', sans-serif; color: rgb(245, 245, 255);">
                                                <th style="padding-left: 8px; width: 10px;" title="Primary Class"></th>
                                                <th style="width: 145px"></th>

                                                @if (!_useObjectiveStats)
                                                {
                                                    <th style="text-align: right; font-weight: 300; width: 60px;" title="Total Points">Points</th>
                                                    <th style=" width: 90px;"></th>
                                                    <th style="font-weight: 300; width: 70px;" title="Net Score">Net Score</th>
                                                }

                                                @*<th style="font-weight: 300; width: 60px;" title="Kills">Kills</th>
                                                <th style="font-weight: 300; width: 60px;" title="Deaths">Deaths</th>*@

                                                @if (_anyRevives)
                                                {
                                                    <th colspan="2" style="font-weight: 300; width: 120px;" title="Kills">
                                                        @*<div style="width: 100%; display: grid; grid-template-rows: 50% 50%; grid-template-columns: 33% 33% 34%;">*@
                                                        <div style="width: 100%; display: grid; grid-template-rows: 50% 50%; grid-template-columns: 50% 50%;">
                                                            <div class="multi-col-header" style="grid-column: 1 / -1; text-align: center; grid-row: 1; font-weight: 400;">Kills</div>
                                                            <div style="grid-row: 2; grid-column: 1; text-align: right;">Secured</div>
                                                            <div style="grid-row: 2; grid-column: 2; text-align: right;">Total</div>
                                                            @*<div style="grid-row: 2; grid-column: 3; text-align: right;">Post-Rev.</div>*@
                                                        </div>
                                                    </th>

                                                    <th colspan="2" style="font-weight: 300; width: 120px;" title="Deaths">
                                                        <div style="width: 100%; display: grid; grid-template-rows: 50% 50%; grid-template-columns: 50% 50%;">
                                                            <div class="multi-col-header" style="grid-column: 1 / -1; text-align: center; grid-row: 1; font-weight: 400;">Deaths</div>
                                                            <div style="grid-row: 2; grid-column: 1; text-align: right;">Final</div>
                                                            <div style="grid-row: 2; grid-column: 2; text-align: right;">Total</div>
                                                        </div>
                                                    </th>

                                                    <th style="font-weight: 300; width: 60px;" title="Revives Given">Revives<br />Given</th>
                                                    <th colspan="3" style="font-weight: 300; width: 180px;" title="Revives Taken">
                                                        @*<div style="width: 100%; display: grid; grid-template-rows: 50% 50%; grid-template-columns: 50% 50%;">*@
                                                        <div style="width: 100%; display: grid; grid-template-rows: 50% 50%; grid-template-columns: 33% 34% 33%;">
                                                            <div class="multi-col-header" style="grid-column: 1 / -1; text-align: center; grid-row: 1; font-weight: 400; margin-left: 4px;">Revives Taken</div>
                                                            <div style="grid-row: 2; grid-column: 1; text-align: right;" title="Average Life in Seconds">Avg. Life</div>
                                                            <div style="grid-row: 2; grid-column: 2; text-align: right;" title="Deaths within 2 seconds of being revived">Inst. Dth.</div>
                                                            <div style="grid-row: 2; grid-column: 3; text-align: right;" title="Kills while on a revived life">Kills</div>
                                                            @*<div style="grid-row: 2; grid-column: 2; text-align: right;">Taken</div>*@
                                                        </div>
                                                    </th>

                                                    @*<th style="font-weight: 300; width: 60px;" title="Kills">Revives<br />Given</th>
                                                    <th style="font-weight: 300; width: 60px;" title="Deaths">Revives<br />Taken</th>*@
                                                }
                                                else
                                                {
                                                    <th style="font-weight: 300; width: 60px;" title="Kills">Kills</th>
                                                    <th style="font-weight: 300; width: 60px;" title="Deaths">Deaths</th>
                                                }

                                                @if (ShowHsr)
                                                {
                                                    <th style="font-weight: 300; width: 55px;" title="Head Shot Percent">
                                                        <div class="ps2-icon headshot tr" style="filter: brightness(100) saturate(100%); display: inline-block; margin-top: 0px;"></div>%
                                                    </th>
                                                }

                                                <th style="font-weight: 300; width: 55px;" title="Damage Assists">Dmg.<br />Asst.</th>
                                                <th style="font-weight: 300; width: 70px;" title="Damage Dealt">Dmg.<br />Dealt</th>
                                                <th style="font-weight: 300; width: 60px;" title="Solo/Unassisted Kills (including spot-assisted-only kills)">Solo<br />Kills</th>
                                                <th style="font-weight: 300; width: 60px;" title="Assisted Deaths (excluding spot-assisted-only deaths)">Asst.<br />Deaths</th>
                                                <th style="font-weight: 300; width: 60px;" title="Trickle Deaths">Trickle<br />Deaths</th>
                                                <th style="font-weight: 300; width: 65px;" title="Favorable Engagement Percent">Favorable<br />Eng. %</th>
                                                <th style="font-weight: 300; width: 65px;" title="One vs One Engagement Percent">1v1<br />Eng. %</th>
                                                <th style="font-weight: 300; width: 60px; padding-right: 8px;" title="One vs One Kill Death Ratio">1v1<br />KDR</th>
                                            </tr>

                                            <tr class="@SqCssHelper.GetFactionClassFromId(ScrimTeamsManager.GetTeam(team.TeamOrdinal).FactionId)" style="color: var(--sq-ov-ps2-primary-light); font-size: 0.9rem; background-color: transparent; border-bottom: 2px solid var(--sq-ov-ps2-primary); text-align: right; border-top: none !important; vertical-align: baseline; line-height: 1.2rem;">
                                                <td style="padding-left: 8px; padding-top: 0px;"></td>
                                                <td style="text-align: left; font-size: 1.2rem;">@(_matchInfo.TeamAliases[team.TeamOrdinal])</td>

                                                @if (!_useObjectiveStats)
                                                {
                                                    <td style="padding-top: 0px;">@team.Points</td>
                                                    <td style="padding-top: 0px;"></td>
                                                    <td style="padding-top: 0px;">@team.NetScore</td>
                                                }

                                                @*<td style="padding-top: 0px;">@team.Kills</td>
                                                <td style="padding-top: 0px;">@team.Deaths</td>

                                                @if (_anyRevives)
                                                {
                                                    <td style="padding-top: 0px;">@team.Revives</td>
                                                    <td style="padding-top: 0px;"></td>
                                                }*@

                                                @if (_anyRevives)
                                                {
                                                    <td style="padding-top: 0px; width: 60px;">@team.SecuredKills</td>
                                                    <td style="padding-top: 0px; width: 60px;">@team.Kills</td>
                                                    <td style="padding-top: 0px; width: 60px;">@team.ConfirmedDeaths</td>
                                                    <td style="padding-top: 0px; width: 60px;">@team.Deaths</td>
                                                    <td style="padding-top: 0px; width: 60px;">@team.Revives</td>
                                                    <td style="padding-top: 0px; width: 60px;">@team.AvgRevivedLifeSeconds<span style="font-size: smaller;">s</span></td>
                                                    <td style="padding-top: 0px; width: 60px;">@team.ReviveInstantDeaths</td>
                                                    <td style="padding-top: 0px; width: 60px;">@team.PostReviveKills</td>
                                                    @*<td style="padding-top: 0px; width: 60px;"></td>*@
                                                }
                                                else
                                                {
                                                    <td style="padding-top: 0px;">@team.Kills</td>
                                                    <td style="padding-top: 0px;">@team.Deaths</td>
                                                }

                                                @if (ShowHsr)
                                                {
                                                    <td style="padding-top: 0px;" title="@team.HeadshotKills / @team.Kills">@team.HeadshotPercent<span style="font-size: smaller;">%</span></td>
                                                }

                                                <td style="padding-top: 0px;">@team.DamageAssists</td>
                                                <td style="padding-top: 0px;" title="@($"{team.TotalDamageDealt.ToString("N0")}\nKills: {team.KillDamageDealt.ToString("N0")}\nAssists: {team.AssistDamageDealt.ToString("N0")}")">@GetAbbreviatedDamageDealt(team.TotalDamageDealt, true)</td>
                                                <td style="padding-top: 0px;">@team.UnassistedKills</td>
                                                <td style="padding-top: 0px;">@team.DamageAssistedEnemyDeaths</td>
                                                <td style="padding-top: 0px;">@team.TrickleDeaths</td>
                                                <td style="padding-top: 0px;" title="@team.FavorableEngagementCount / @team.WeightedEnemyEngagementCount">@team.WeightedFavorableEngagementPercent3<span style="font-size: smaller;">%</span></td>
                                                <td style="padding-top: 0px;" title="@team.OneVsOneCount / @team.EnemyKillDeathEngagementCount">@team.OneVsOneEngagementPercent<span style="font-size: smaller;">%</span></td>
                                                <td style="padding-top: 0px; padding-right: 8px;" title="@team.UnassistedKills / @team.UnassistedEnemyDeaths ">@team.OneVsOneKillDeathRatio</td>
                                            </tr>

                                            @foreach (var player in _playerRoundStats.Where(p => p.TeamOrdinal == team.TeamOrdinal && p.ScrimMatchRound == _currentRound))
                                            {
                                                <tr class="@SqCssHelper.GetFactionClassFromId(player.FactionId)" style="color: rgb(245, 245, 255); font-weight: 400;">
                                                    <td style="padding-left: 8px;">
                                                        <div class="playerLoadoutIcon ps2-icon @GetLoadoutIconFromLoadoutId(player.GetOrderedPlanetsideClassEventCountsList().Select(e => e.PlanetsideClass).FirstOrDefault())" style="filter: @GetLoadoutIconFilterStyle(player.FactionId)"></div>@*@player.GetOrderedPlanetsideClassEventCountsList().OrderByDescending(e => e.EventCount).FirstOrDefault().EventCount</div>*@
                                                    </td>
                                                    <td style="text-align: left;" title="@player.NameFull [@(player.CharacterId)]">
                                                        <div class="nav-link" style="color: rgb(245, 245, 255);">
                                                            <span style="text-overflow: ellipsis; overflow: hidden; max-width: 120px; display: inline-block; vertical-align: bottom;">@player.NameDisplay</span>
                                                            @*<span style="text-overflow: ellipsis; overflow: hidden; max-width: @(player.PrestigeLevel != 0 ? "108px" : "120px"); display: inline-block; vertical-align: bottom;">@player.NameDisplay</span>
                                                            @if (player.PrestigeLevel != 0)
                                                            {
                                                                <div style="display: inline-block; margin-left: -4px;" title="ASP Active">
                                                                    <sup>
                                                                        <span class="oi oi-star small" aria-hidden="true"></span>
                                                                    </sup>
                                                                </div>
                                                            }*@
                                                        </div>
                                                    </td>

                                                    @if (!_useObjectiveStats)
                                                    {
                                                        <td style="text-align: right; opacity: @(GetStatOpacity(player.Points));">@player.Points</td>
                                                        <td>
                                                            <div class="graph" style="width: 90px;">
                                                                <div class="graph-bar" style="width: @($"{GetPointGraphWidth(player.Points)}%"); height: 17px; margin: 0; background-color: var(--sq-ov-ps2-primary); opacity: 0.9; box-sizing: border-box; border: 1px solid var(--sq-ov-ps2-primary-dark-alpha-80); border-left: 2px solid var(--sq-ov-ps2-primary-dark);"></div>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <div class="net stats-value" style="margin-top: -0.1rem !important;">
                                                                <span class="value">@player.NetScore</span><span class="net-score-icon @GetNetScoreLabelCssClass(player.NetScore)">@GetNetScoreLabelText(player.NetScore)</span>
                                                            </div>
                                                        </td>
                                                    }

                                                    @*<td style="opacity: @(GetStatOpacity(player.Kills));">@player.Kills</td>
                                                    <td style="opacity: @(GetStatOpacity(player.Deaths));">@player.Deaths</td>

                                                    @if (_anyRevives)
                                                    {
                                                        <td style="padding-top: 0px; opacity: @(GetStatOpacity(player.RevivesGiven));">@player.RevivesGiven</td>
                                                        <td style="padding-top: 0px; opacity: @(GetStatOpacity(player.RevivesTaken));">@player.RevivesTaken</td>
                                                    }*@

                                                    @if (_anyRevives)
                                                    {
                                                        <td style="padding-top: 0px; opacity: @(GetStatOpacity(player.SecuredKills));">@player.SecuredKills</td>
                                                        <td style="padding-top: 0px; opacity: @(GetStatOpacity(player.Kills));">@player.Kills</td>
                                                        <td style="padding-top: 0px; opacity: @(GetStatOpacity(player.ConfirmedDeaths));">@player.ConfirmedDeaths</td>
                                                        <td style="padding-top: 0px; opacity: @(GetStatOpacity(player.Deaths));">@player.Deaths</td>
                                                        <td style="padding-top: 0px; opacity: @(GetStatOpacity(player.RevivesGiven));">@player.RevivesGiven</td>
                                                        @*<td style="padding-top: 0px; opacity: @(GetStatOpacity(player.ConfirmedDeaths));">@player.AvgRevivedLifeSeconds<span style="font-size: smaller;">s</span></td>*@
                                                        <td style="padding-top: 0px; opacity: @(GetStatOpacity(player.RevivesTaken));">@player.AvgRevivedLifeSeconds<span style="font-size: smaller;">s</span></td>
                                                        <td style="padding-top: 0px; opacity: @(GetStatOpacity(player.RevivesTaken));">@player.ReviveInstantDeaths</td>
                                                        <td style="padding-top: 0px; opacity: @(GetStatOpacity(player.RevivesTaken));">@player.PostReviveKills</td>
                                                        @*<td style="padding-top: 0px; opacity: @(GetStatOpacity(player.RevivesTaken));">@player.RevivesTaken</td>*@
                                                    }
                                                    else
                                                    {
                                                        <td style="padding-top: 0px; opacity: @(GetStatOpacity(player.Kills));">@player.Kills</td>
                                                        <td style="padding-top: 0px; opacity: @(GetStatOpacity(player.Deaths));">@player.Deaths</td>
                                                    }

                                                    @if (ShowHsr)
                                                    {
                                                        <td style="opacity: @(GetStatOpacity(player.Kills));" title="@player.HeadshotKills / @player.Kills">@player.HeadshotPercent<span style="font-size: smaller; padding-left: 1px;">%</span></td>
                                                    }

                                                    <td style="opacity: @(GetStatOpacity(player.DamageAssists));">@player.DamageAssists</td>
                                                    <td style="opacity: @(GetStatOpacity(player.TotalDamageDealt));" title="@($"{player.TotalDamageDealt.ToString("N0")}\nKills: {player.KillDamageDealt.ToString("N0")}\nAssists: {player.AssistDamageDealt.ToString("N0")}")">@player.TotalDamageDealt.ToString("N0")</td>
                                                    <td style="opacity: @(GetStatOpacity(player.UnassistedKills));">@player.UnassistedKills</td>
                                                    <td style="opacity: @(GetStatOpacity(player.DamageAssistedEnemyDeaths));">@player.DamageAssistedEnemyDeaths</td>
                                                    <td style="opacity: @(GetStatOpacity(player.TrickleDeaths));">@player.TrickleDeaths</td>
                                                    <td style="opacity: @(GetStatOpacity((int)player.WeightedEnemyEngagementCount));" title="@player.FavorableEngagementCount / @player.WeightedEnemyEngagementCount">@player.WeightedFavorableEngagementPercent3<span style="font-size: smaller; padding-left: 1px;">%</span></td>
                                                    <td style="opacity: @(GetStatOpacity(player.EnemyKillDeathEngagementCount));" title="@player.OneVsOneCount / @player.EnemyKillDeathEngagementCount">@player.OneVsOneEngagementPercent<span style="font-size: smaller; padding-left: 1px;">%</span></td>
                                                    <td style="padding-right: 8px; opacity: @(GetStatOpacity(player.UnassistedKills + player.UnassistedEnemyDeaths));" title="@player.UnassistedKills / @player.UnassistedEnemyDeaths">@player.OneVsOneKillDeathRatio</td>
                                                </tr>
                                                @*<tr style="height: 8px; background-color: transparent;"></tr>*@
                                            }

                                            @if (team.FacilityCapturePoints != 0)
                                            {
                                                <tr class="@SqCssHelper.GetFactionClassFromId(_playerRoundStats.Where(p => p.TeamOrdinal == team.TeamOrdinal).Select(p => p.FactionId).FirstOrDefault())" style="background-color: transparent;">
                                                    <td style="padding-left: 10px;"></td>
                                                    <td colspan="1" style="text-align: left;">Captures</td>
                                                    <td>@team.FacilityCapturePoints</td>
                                                    <td colspan="12"></td>
                                                </tr>
                                            }

                                            @if (team.PeriodicControlTickPoints != 0)
                                            {
                                                <tr class="@SqCssHelper.GetFactionClassFromId(_playerRoundStats.Where(p => p.TeamOrdinal == team.TeamOrdinal).Select(p => p.FactionId).FirstOrDefault())" style="background-color: transparent;">
                                                    <td style="padding-left: 10px;"></td>
                                                    <td colspan="1" style="text-align: left;">Control Ticks</td>
                                                    <td colspan="1" >@(team.PeriodicControlTickPoints)</td>
                                                    <td colspan="2" style="text-align: left; padding-left: 0.25rem; font-weight: 500;">(@(team.PeriodicControlTicks) ticks)</td>
                                                    <td colspan="9"></td>
                                                </tr>
                                            }

                                            <tr class="@SqCssHelper.GetFactionClassFromId(_playerRoundStats.Where(p => p.TeamOrdinal == team.TeamOrdinal).Select(p => p.FactionId).FirstOrDefault())" style="background-color: transparent; border-bottom: 1px solid var(--sq-ov-ps2-primary);"></tr>

                                        }
                                    }
                                </tbody>
                            </table>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
}
else
{
    @if (Debug)
    {
        <div>Match ID Is Null</div>
    }
}



